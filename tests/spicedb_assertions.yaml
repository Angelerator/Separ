# SpiceDB Quick Assertions for Integration Tests
# These can be loaded into SpiceDB during integration tests
# 
# Format compatible with SpiceDB Playground and zed validate

schema: |-
  definition platform {
      relation admin: user | service_account
      relation member: user | service_account
      
      permission manage = admin
      permission view = admin + member
  }

  definition tenant {
      relation platform: platform
      relation owner: user | service_account
      relation admin: user | service_account | group#member
      relation member: user | service_account | group#member
      
      permission manage = owner + admin + platform->admin
      permission view = owner + admin + member + platform->admin
      permission create_workspace = owner + admin
      permission manage_users = owner + admin
      permission manage_groups = owner + admin
      permission manage_oauth = owner + admin
      permission view_audit = owner + admin
  }

  definition workspace {
      relation tenant: tenant
      relation owner: user | service_account
      relation admin: user | service_account | group#member
      relation member: user | service_account | group#member
      relation viewer: user | service_account | group#member
      
      permission manage = owner + admin + tenant->manage
      permission view = owner + admin + member + viewer + tenant->manage
      permission create_application = owner + admin + tenant->manage
      permission manage_members = owner + admin
      permission invite = owner + admin
  }

  definition user {
      relation self: user
      relation tenant: tenant
      
      permission manage = self + tenant->manage_users
      permission view = self + tenant->view
  }

  definition group {
      relation tenant: tenant
      relation owner: user | service_account
      relation admin: user | service_account
      relation member: user | service_account | group#member
      
      permission manage = owner + admin + tenant->manage_groups
      permission view = owner + admin + member + tenant->view
      permission add_member = owner + admin
      permission remove_member = owner + admin
  }

  definition service_account {
      relation tenant: tenant
      relation owner: user
      relation admin: user | group#member
      
      permission manage = owner + admin + tenant->manage
      permission use = owner + admin
      permission rotate_credentials = owner + admin
  }

# Test data for workspace-first model
relationships: |-
  workspace:personal_ws#owner@user:alice
  workspace:team_ws#owner@user:bob
  workspace:team_ws#member@user:carol
  platform:default#admin@user:superadmin
  tenant:acme#platform@platform:default
  tenant:acme#owner@user:cto
  tenant:acme#member@user:employee
  workspace:org_ws#tenant@tenant:acme
  workspace:org_ws#owner@user:team_lead
  workspace:org_ws#member@user:developer

assertions:
  assertTrue:
    # Personal workspace - owner has full access
    - "workspace:personal_ws#manage@user:alice"
    - "workspace:personal_ws#view@user:alice"
    
    # Team workspace - owner has full access
    - "workspace:team_ws#manage@user:bob"
    # Team workspace - member can view
    - "workspace:team_ws#view@user:carol"
    
    # Organization workspace - tenant owner inherits access
    - "workspace:org_ws#manage@user:cto"
    # Organization workspace - direct owner has access
    - "workspace:org_ws#manage@user:team_lead"
    # Organization workspace - member can view
    - "workspace:org_ws#view@user:developer"
    
    # Platform admin has cross-tenant access
    - "tenant:acme#manage@user:superadmin"
    
  assertFalse:
    # Personal workspace isolation
    - "workspace:personal_ws#view@user:bob"
    
    # Team workspace - members cannot manage
    - "workspace:team_ws#manage@user:carol"
    
    # Tenant members cannot manage tenant
    - "tenant:acme#manage@user:employee"
    
    # Cross-tenant isolation
    - "workspace:personal_ws#view@user:employee"
