syntax = "proto3";
package authzed.api.v1;

option go_package = "github.com/authzed/authzed-go/proto/authzed/api/v1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// ObjectReference is used to refer to a specific object in the system.
message ObjectReference {
  string object_type = 1;
  string object_id = 2;
}

// SubjectReference is used to refer to the subject of a relationship.
message SubjectReference {
  ObjectReference object = 1;
  string optional_relation = 2;
}

// Relationship represents a relationship between a resource and a subject.
message Relationship {
  ObjectReference resource = 1;
  string relation = 2;
  SubjectReference subject = 3;
  ContextualizedCaveat optional_caveat = 4;
  google.protobuf.Timestamp optional_expires_at = 5;
}

// ContextualizedCaveat provides a caveat and its context.
message ContextualizedCaveat {
  string caveat_name = 1;
  google.protobuf.Struct context = 2;
}

// ZedToken is used for consistency tokens.
message ZedToken {
  string token = 1;
}

// Cursor is used for pagination.
message Cursor {
  string token = 1;
}

// RelationshipUpdate is used for mutating a single relationship.
message RelationshipUpdate {
  enum Operation {
    OPERATION_UNSPECIFIED = 0;
    OPERATION_CREATE = 1;
    OPERATION_TOUCH = 2;
    OPERATION_DELETE = 3;
  }
  Operation operation = 1;
  Relationship relationship = 2;
}

// PermissionRelationshipTree is used for representing a tree of permissions.
message PermissionRelationshipTree {
  oneof tree_type {
    AlgebraicSubjectSet intermediate = 1;
    DirectSubjectSet leaf = 2;
  }
  ObjectReference expanded_object = 3;
  string expanded_relation = 4;
}

// AlgebraicSubjectSet is a subject set computed by applying an operation.
message AlgebraicSubjectSet {
  enum Operation {
    OPERATION_UNSPECIFIED = 0;
    OPERATION_UNION = 1;
    OPERATION_INTERSECTION = 2;
    OPERATION_EXCLUSION = 3;
  }
  Operation operation = 1;
  repeated PermissionRelationshipTree children = 2;
}

// DirectSubjectSet is a collection of subjects.
message DirectSubjectSet {
  repeated SubjectReference subjects = 1;
}// PartialCaveatInfo carries information for partially evaluated caveats.
message PartialCaveatInfo {
  repeated string missing_required_context = 1;
}
