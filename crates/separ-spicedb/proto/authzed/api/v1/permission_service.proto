syntax = "proto3";
package authzed.api.v1;

option go_package = "github.com/authzed/authzed-go/proto/authzed/api/v1";

import "authzed/api/v1/core.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

service PermissionsService {
  rpc ReadRelationships(ReadRelationshipsRequest) returns (stream ReadRelationshipsResponse);
  rpc WriteRelationships(WriteRelationshipsRequest) returns (WriteRelationshipsResponse);
  rpc DeleteRelationships(DeleteRelationshipsRequest) returns (DeleteRelationshipsResponse);
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
  rpc CheckBulkPermissions(CheckBulkPermissionsRequest) returns (CheckBulkPermissionsResponse);
  rpc ExpandPermissionTree(ExpandPermissionTreeRequest) returns (ExpandPermissionTreeResponse);
  rpc LookupResources(LookupResourcesRequest) returns (stream LookupResourcesResponse);
  rpc LookupSubjects(LookupSubjectsRequest) returns (stream LookupSubjectsResponse);
  rpc ImportBulkRelationships(stream ImportBulkRelationshipsRequest) returns (ImportBulkRelationshipsResponse);
  rpc ExportBulkRelationships(ExportBulkRelationshipsRequest) returns (stream ExportBulkRelationshipsResponse);
}

// Consistency levels
message Consistency {
  oneof requirement {
    bool minimize_latency = 1;
    ZedToken at_least_as_fresh = 2;
    ZedToken at_exact_snapshot = 3;
    bool fully_consistent = 4;
  }
}

// RelationshipFilter is used to filter relationships.
message RelationshipFilter {
  string resource_type = 1;
  string optional_resource_id = 2;
  string optional_relation = 3;
  SubjectFilter optional_subject_filter = 4;
  string optional_resource_id_prefix = 5;
}

// SubjectFilter is used to filter subjects in relationship queries.
message SubjectFilter {
  message RelationFilter {
    string relation = 1;
  }

  string subject_type = 1;
  string optional_subject_id = 2;
  RelationFilter optional_relation = 3;
}

// ReadRelationships
message ReadRelationshipsRequest {
  Consistency consistency = 1;
  RelationshipFilter relationship_filter = 2;
  uint32 optional_limit = 3;
  Cursor optional_cursor = 4;
}

message ReadRelationshipsResponse {
  ZedToken read_at = 1;
  Relationship relationship = 2;
  Cursor after_result_cursor = 3;
}

// Precondition
message Precondition {
  enum Operation {
    OPERATION_UNSPECIFIED = 0;
    OPERATION_MUST_NOT_MATCH = 1;
    OPERATION_MUST_MATCH = 2;
  }
  Operation operation = 1;
  RelationshipFilter filter = 2;
}

// WriteRelationships
message WriteRelationshipsRequest {
  repeated RelationshipUpdate updates = 1;
  repeated Precondition optional_preconditions = 2;
  google.protobuf.Struct optional_transaction_metadata = 3;
}

message WriteRelationshipsResponse {
  ZedToken written_at = 1;
}

// DeleteRelationships
message DeleteRelationshipsRequest {
  RelationshipFilter relationship_filter = 1;
  repeated Precondition optional_preconditions = 2;
  uint32 optional_limit = 3;
  bool optional_allow_partial_deletions = 4;
  google.protobuf.Struct optional_transaction_metadata = 5;
}

message DeleteRelationshipsResponse {
  enum DeletionProgress {
    DELETION_PROGRESS_UNSPECIFIED = 0;
    DELETION_PROGRESS_COMPLETE = 1;
    DELETION_PROGRESS_PARTIAL = 2;
  }
  ZedToken deleted_at = 1;
  DeletionProgress deletion_progress = 2;
  uint64 relationships_deleted_count = 3;
}

// CheckPermission
message CheckPermissionRequest {
  Consistency consistency = 1;
  ObjectReference resource = 2;
  string permission = 3;
  SubjectReference subject = 4;
  google.protobuf.Struct context = 5;
  bool with_tracing = 6;
}

message CheckPermissionResponse {
  enum Permissionship {
    PERMISSIONSHIP_UNSPECIFIED = 0;
    PERMISSIONSHIP_NO_PERMISSION = 1;
    PERMISSIONSHIP_HAS_PERMISSION = 2;
    PERMISSIONSHIP_CONDITIONAL_PERMISSION = 3;
  }
  ZedToken checked_at = 1;
  Permissionship permissionship = 2;
  PartialCaveatInfo partial_caveat_info = 3;
  DebugInformation debug_trace = 4;
  google.protobuf.Timestamp optional_expires_at = 5;
}

message DebugInformation {
  CheckDebugTrace check = 1;
  string schema_used = 2;
}

message CheckDebugTrace {
  enum PermissionType {
    PERMISSION_TYPE_UNSPECIFIED = 0;
    PERMISSION_TYPE_RELATION = 1;
    PERMISSION_TYPE_PERMISSION = 2;
  }
  ObjectReference resource = 1;
  string permission = 2;
  PermissionType permission_type = 3;
  SubjectReference subject = 4;
  CheckPermissionResponse.Permissionship result = 5;
  CaveatEvalInfo caveat_evaluation_info = 6;
  uint32 duration = 7;
  oneof resolution {
    bool was_cached_result = 8;
    SubProblems sub_problems = 9;
  }
}

message SubProblems {
  repeated CheckDebugTrace traces = 1;
}

message CaveatEvalInfo {
  enum Result {
    RESULT_UNSPECIFIED = 0;
    RESULT_UNEVALUATED = 1;
    RESULT_FALSE = 2;
    RESULT_TRUE = 3;
    RESULT_MISSING_SOME_CONTEXT = 4;
  }
  string expression = 1;
  Result result = 2;
  google.protobuf.Struct context = 3;
  google.protobuf.Struct partial_caveat_info = 4;
  string caveat_name = 5;
}

// CheckBulkPermissions
message CheckBulkPermissionsRequest {
  Consistency consistency = 1;
  repeated CheckBulkPermissionsRequestItem items = 2;
  bool with_tracing = 3;
}

message CheckBulkPermissionsRequestItem {
  ObjectReference resource = 1;
  string permission = 2;
  SubjectReference subject = 3;
  google.protobuf.Struct context = 4;
}

message CheckBulkPermissionsResponse {
  ZedToken checked_at = 1;
  repeated CheckBulkPermissionsPair pairs = 2;
}

message CheckBulkPermissionsPair {
  CheckBulkPermissionsRequestItem request = 1;
  oneof response {
    CheckBulkPermissionsResponseItem item = 2;
    CheckBulkPermissionsError error = 3;
  }
}

message CheckBulkPermissionsResponseItem {
  CheckPermissionResponse.Permissionship permissionship = 1;
  PartialCaveatInfo partial_caveat_info = 2;
  DebugInformation debug_trace = 3;
}

message CheckBulkPermissionsError {
  uint32 code = 1;
  string message = 2;
}

// ExpandPermissionTree
message ExpandPermissionTreeRequest {
  Consistency consistency = 1;
  ObjectReference resource = 2;
  string permission = 3;
}

message ExpandPermissionTreeResponse {
  ZedToken expanded_at = 1;
  PermissionRelationshipTree tree_root = 2;
}

// LookupResources
message LookupResourcesRequest {
  Consistency consistency = 1;
  string resource_object_type = 2;
  string permission = 3;
  SubjectReference subject = 4;
  google.protobuf.Struct context = 5;
  uint32 optional_limit = 6;
  Cursor optional_cursor = 7;
}

enum LookupPermissionship {
  LOOKUP_PERMISSIONSHIP_UNSPECIFIED = 0;
  LOOKUP_PERMISSIONSHIP_HAS_PERMISSION = 1;
  LOOKUP_PERMISSIONSHIP_CONDITIONAL_PERMISSION = 2;
}

message LookupResourcesResponse {
  ZedToken looked_up_at = 1;
  string resource_object_id = 2;
  LookupPermissionship permissionship = 3;
  PartialCaveatInfo partial_caveat_info = 4;
  Cursor after_result_cursor = 5;
}

// LookupSubjects
message LookupSubjectsRequest {
  enum WildcardOption {
    WILDCARD_OPTION_UNSPECIFIED = 0;
    WILDCARD_OPTION_INCLUDE_WILDCARDS = 1;
    WILDCARD_OPTION_EXCLUDE_WILDCARDS = 2;
  }

  Consistency consistency = 1;
  ObjectReference resource = 2;
  string permission = 3;
  string subject_object_type = 4;
  string optional_subject_relation = 5;
  google.protobuf.Struct context = 6;
  uint32 optional_concrete_limit = 7;
  Cursor optional_cursor = 8;
  WildcardOption wildcard_option = 9;
}

message LookupSubjectsResponse {
  ZedToken looked_up_at = 1;
  string subject_object_id = 2;
  repeated string excluded_subject_ids = 3;
  LookupPermissionship permissionship = 4;
  PartialCaveatInfo partial_caveat_info = 5;
  ResolvedSubject subject = 6;
  repeated ResolvedSubject excluded_subjects = 7;
  Cursor after_result_cursor = 8;
}

message ResolvedSubject {
  string subject_object_id = 1;
  LookupPermissionship permissionship = 2;
  PartialCaveatInfo partial_caveat_info = 3;
}

// ImportBulkRelationships
message ImportBulkRelationshipsRequest {
  repeated Relationship relationships = 1;
}

message ImportBulkRelationshipsResponse {
  uint64 num_loaded = 1;
}// ExportBulkRelationships
message ExportBulkRelationshipsRequest {
  Consistency consistency = 1;
  uint32 optional_limit = 2;
  Cursor optional_cursor = 3;
  RelationshipFilter optional_relationship_filter = 4;
}message ExportBulkRelationshipsResponse {
  Cursor after_result_cursor = 1;
  repeated Relationship relationships = 2;
}
